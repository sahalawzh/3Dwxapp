"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _objectWithoutProperties(t,e){var s={};for(var a in t)e.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(t,a)&&(s[a]=t[a]);return s}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,s=Array(t.length);e<t.length;e++)s[e]=t[e];return s}return Array.from(t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(t[a]=s[a])}return t},_theme_behaviors=require("./../package_help/theme_behaviors.js"),_theme_behaviors2=_interopRequireDefault(_theme_behaviors),accMul=function(t,e){var s=0,a="",i="";try{a=t.toString(),s+=a.split(".")[1].length}catch(t){}try{i=e.toString(),s+=i.split(".")[1].length}catch(t){}return Number(a.replace(".",""))*Number(i.replace(".",""))/Math.pow(10,s)},parseSpec=function(t,e){var s=[],a=[];return e=e||[],t.forEach(function(t,i){var o=t.spec_data,r=o.length,n=e[i];if(r){var u=!1;t.spec_data.forEach(function(t){var e=t.spec_id;s.push(i+"_"+e),+e==+n&&(u=!0)}),a.push(u?n:-1)}}),{info:s,specComb:a}},parseSku=function(t){var e={},s={};return t.forEach(function(t){var a=t.id,i=t.spec_ids;e[a]=t,s[i.join("_")]=a}),{info:e,keys:s}};exports.default=Component({behaviors:[_theme_behaviors2.default],properties:{locked:{type:String,value:"true"},spec:{type:Array},sku:{type:Array},value:{type:[String|Array|Number],value:""},num:{type:String,value:1},quota:{type:String},showStock:{type:String,value:"false"},showQuota:{type:String,value:"false"},resetNumOnCancel:{type:String,value:"true"},resetSkuOnCancel:{type:String,value:"false"},resetNumOnChangeSkuComb:{type:String,value:"false"},disabledStepper:{type:String,value:"false"},status:{type:String,value:"hide",observer:function(t){"show"!==t&&"hide"!==t||this.setData({boxStatus:t})}},good:{type:Object,value:{}},buttonText:{type:String,value:"立即购买",observer:function(t,e){t!==e&&this.setData({buttonText:t})}},symbol:{type:String},skuTheme:{type:String,value:"full"},showMinPurchase:{type:String,value:"false"},minPurchaseNum:{type:Number,value:1}},data:{boxStatus:"hide",disabled:!0,skuSpecKeys:{},specInfo:{},skuInfo:{},maxComb:0,specItemComb:{},specStatus:{},specComb:[],height:"374",innerQuota:"",min:1},ready:function(){this.triggerEvent("skuready",{},{})},attached:function(){var t=this._initSku();"full"===this.data.skuTheme&&(t.gaps=["30rpx","30rpx","130rpx","30rpx"]),this.setData(t)},methods:{_skuPopupClose:function(t){var e=this.data,s=e.disabled,a=e.num,i={num:a,trigger:"close"};if(!s){var o=this._getSku();Object.assign(i,o)}this.triggerEvent("skuchange",i,{}),this.setData({boxStatus:"hide"})},_skutap:function(){var t=this.data,e=t.disabled,s=t.num,a=t.showMinPurchase,i=t.minPurchaseNum;if(this._isFullSpecComb()){var o=this._getSku(),r=o.stock;if("true"===a&&i>r&&r>0)return void this.triggerEvent("minDisable")}if(!e){var n=this._getSku(),u=Object.assign({num:s,trigger:"button"},n);this.triggerEvent("skuchange",u,{}),this.setData({status:"hide"})}},_getListMaxHeight:function(){var t=wx.windowHeight,e=wx.windowWidth,s=wx.rpx2px;if(!t){var a=wx.getSystemInfoSync();t=a.windowHeight,e=a.windowWidth,s=e/750,wx.windowHeight=t,wx.windowWidth=e,wx.rpx2px=s}return t-=("full"===this.data.skuTheme?578:456)*s},_updateSkuInfo:function(t){var e=this.data.skuInfo;for(var s in t)e[s]&&(this.data.skuInfo[s]=Object.assign({},e[s],t[s]))},_getValidSpecCombStock:function(t){var e=this.data,s=e.skuSpecKeys,a=e.skuInfo,i=[];t.forEach(function(t){i.push(-1===t?"\\d+":t)});var o=new RegExp(i.join("_")),r=[];for(var n in s)o.test(n)&&r.push(a[s[n]]);return r.reduce(function(t,e){return t+=+e.stock},0)},_checkSpecStatus:function(t,e){var s=this.data.specComb,a=s.concat();return a[t]=e,this._getValidSpecCombStock(a)<1},_updateSpecStatus:function(){var t=this,e=this.data.specInfo,s={};return e.forEach(function(e){s[e]=t._checkSpecStatus.apply(t,_toConsumableArray(e.split("_")))}),s},_isFullSpecComb:function(){return-1===this.data.specComb.indexOf(-1)},_getSku:function(){var t=this.data,e=t.specComb;return t.skuInfo[t.skuSpecKeys[e.join("_")]]},_getLowestPrice:function(){var t=this.data,e=t.skuInfo,s=t.symbol,a=void 0,i=void 0;for(var o in e){var r=e[o],n=r.stock,u=r.price,c=r.points,h=s?u:c;i=void 0===i?h:Math.min(h,i),n>1&&(a=void 0===a?h:Math.min(h,a))}return a||i},_pickSpec:function(t){var e=t.currentTarget,s=e.dataset,a=s.sid,i=s.row,o=this.data,r=o.specStatus,n=o.specComb,u=o.good,c=o.num,h=o.symbol;if(!r[i+"_"+a]){n[i]=a===n[i]?-1:a;var p=!this._isFullSpecComb(),d=this._updateSpecStatus(),l={specComb:n,disabled:p,specStatus:d};if(p)u.stock=this._getValidSpecCombStock(n);else{var g=this._getSku(),f=g.price,v=g.stock,S=g.img,m=g.points,k=h?f:m;u.price=k,u.stock=v,S&&(u.img=S),l.totalPrice=accMul(c,k)}l.innerQuota=this._getQuota(u.stock),l.good=u,this.setData(l)}},_getQuota:function(t){var e=this.data.quota;return t?e?Math.min(+e,t):t:e},_changeNum:function(t){var e=this.data,s=e.disabled,a=e.num,i=e.symbol,o=e.showMinPurchase,r=e.minPurchaseNum,n=t.detail,u=n.value;n.trigger;if(s)this.setData({num:u});else{if(u===a)return;var c=this._getSku(),h=c.price,p=c.stock,d=c.points;u>p&&(u=p);var l=accMul("true"===o&&r>u?r:u,i?h:d);this.setData({totalPrice:l,num:u})}},_stepperDisableTap:function(t){},_initSku:function(t){var e=Object.assign({},this.data,t),s=e.spec,a=e.sku,i=e.good,o=e.num,r=e.showStock,n=e.value,u=e.symbol,c=e.quota,h=0;if(!s.length||!a.length)return{};Array.isArray(n)&&n.length>1?h=1:("string"==typeof n||n>0)&&(h=2);var p=parseSpec(s,1===h?n:null),d=p.info,l=p.specComb,g=parseSku(a),f=g.info,v=g.keys;this.data.specInfo=d,this.data.skuSpecKeys=v,this.data.skuInfo=f,2===h&&f[n]&&(l=f[n].spec_ids),this.data.specComb=l;var S=!this._isFullSpecComb(),m=this._updateSpecStatus(),k=this._getListMaxHeight(),_=void 0,b=void 0;if(S)_=this._getLowestPrice();else{var y=this._getSku(),w=y.price,x=y.stock,C=y.img,P=y.points;_=u?w:P,b=x,C&&(i.img=C)}i.price=_;var D={specComb:l,specStatus:m,height:k,disabled:S,good:i,num:o,totalPrice:accMul(o,_),innerQuota:c};return r&&(D.good.stock=S?this._getValidSpecCombStock(l):b),D},updateSku:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=this.data,a=s.good,i=s.specComb,o=s.symbol,r=s.num;for(var n in e)this.data[n]=e[n];this._updateSkuInfo(t);var u=this._updateSpecStatus(),c=Object.assign({},{specStatus:u},e);if(this._isFullSpecComb()){var h=this._getSku(),p=h.price,d=h.stock,l=h.img,g=h.points,f=o?p:g;a.price=f,a.stock=d,l&&(a.img=l),c.totalPrice=accMul(r,f)}else a.price=this._getLowestPrice(),a.stock=this._getValidSpecCombStock(i),c.totalPrice=accMul(r,a.price);c.good=a,c.innerQuota=this._getQuota(a.stock),this.setData(c)},updateSkuSettings:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.setData(t)},initComponent:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.spec,s=t.sku,a=t.value,i=t.good,o=t.num,r=t.showStock,n=_objectWithoutProperties(t,["spec","sku","value","good","num","showStock"]);for(var u in n)this.data[u]=n[u];var c=this._initSku({spec:e,sku:s,good:i,value:a,num:void 0===o?this.data.num:o,showStock:void 0===r?this.data.showStock:r});return this.setData(_extends({spec:e,sku:s},c,n)),this},show:function(){this.setData({status:"show",boxStatus:"show"})},hide:function(){this.setData({status:"hide",boxStatus:"hide"})},toggle:function(t){var e=this.data.status;"boolean"!=typeof t&&(t="show"!==e),t?this.show():this.hide()}}});